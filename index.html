<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visualisasi Konstruksi Indonesia</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f2f2f2;
      }
      h1 {
        text-align: center;
        background: #005b96;
        color: white;
        padding: 10px;
      }
      #controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
        margin: 10px;
      }
      select,
      button {
        padding: 6px;
        font-size: 16px;
      }
      #map {
        height: 600px;
        margin: 0 auto 20px;
        width: 95%;
        border: 2px solid #ccc;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Visualisasi Geospasial Data Konstruksi Indonesia</h1>

    <div id="controls">
      <label for="kategori"
        >Kategori:
        <select id="kategori">
          <option value="upah">Upah Harian</option>
          <option value="hari_kerja">Hari Kerja</option>
          <option value="nilai_kontrak">Nilai Kontrak</option>
        </select>
      </label>

      <label for="tahun"
        >Tahun:
        <select id="tahun">
          <option value="2023">2023</option>
          <option value="2022">2022</option>
          <option value="2021">2021</option>
        </select>
      </label>

      <button onclick="loadMap()">Tampilkan</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      const map = L.map("map").setView([-2.5, 118], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      let geoLayer;

      async function loadMap() {
        const kategori = document.getElementById("kategori").value;
        const tahun = document.getElementById("tahun").value;

        if (geoLayer) map.removeLayer(geoLayer);

        try {
          // Ambil data geojson dan data statistik dari server
          const [geoRes, dataRes] = await Promise.all([
            fetch("http://localhost:3000/api/geojson"),
            fetch(`http://localhost:3000/api/${kategori}?tahun=${tahun}`),
          ]);

          const geojsonData = await geoRes.json();
          const data = await dataRes.json();

          // Buat peta provinsi -> data
          const dataMap = {};
          for (const item of data) {
            if (item.provinsi) {
              dataMap[item.provinsi.toUpperCase()] = item;
            }
          }

          geoLayer = L.layerGroup();

          geojsonData.forEach((region) => {
            const provKey = region.province?.toUpperCase();
            const statistik = dataMap[provKey];
            const value = getValue(statistik, kategori);

            const shape = L.geoJSON(region.geojson, {
              style: {
                color: "#000",
                weight: 1,
                fillColor: getColor(value, kategori),
                fillOpacity: 0.7,
              },
              onEachFeature: (feature, layer) => {
                const label = getLabel(kategori);
                const popup = `
              <strong>${region.province}</strong><br>
              Tahun: ${tahun}<br>
              ${label}: ${value ?? "N/A"}
            `;
                layer.bindPopup(popup);
              },
            });

            geoLayer.addLayer(shape);
          });

          geoLayer.addTo(map);
        } catch (err) {
          alert(
            "Gagal memuat data dari server. Pastikan server.js sedang berjalan."
          );
          console.error(err);
        }
      }

      function getValue(row, kategori) {
        if (!row) return null;
        if (kategori === "upah") return parseFloat(row.upah);
        if (kategori === "hari_kerja") return parseInt(row.hari_kerja);
        if (kategori === "nilai_kontrak") return parseFloat(row.nilai_kontrak);
        return null;
      }

      function getLabel(kategori) {
        return (
          {
            upah: "Upah Harian (rb)",
            hari_kerja: "Hari Kerja",
            nilai_kontrak: "Nilai Kontrak",
          }[kategori] || "Nilai"
        );
      }

      function getColor(val, kategori) {
        if (val == null || isNaN(val)) return "#ccc";

        const scale = {
          upah: [120, 135, 150, 165],
          hari_kerja: [100, 120, 130, 140],
          nilai_kontrak: [110, 130, 150, 170],
        }[kategori];

        return val > scale[3]
          ? "#800026"
          : val > scale[2]
          ? "#BD0026"
          : val > scale[1]
          ? "#E31A1C"
          : val > scale[0]
          ? "#FC4E2A"
          : "#FFEDA0";
      }

      // Load awal saat halaman dibuka
      loadMap();
    </script>
  </body>
</html>
